<!doctype html>
<html lang="en">
<head>
// netlify/functions/ts-proxy.js
const https = require("https");
const { URL } = require("url");

const TS_URL = "https://api.tripleseat.com/v1/leads/create.js?lead_form_id=44948&public_key=b5c6a2f2358a55bfd720875530a3bcc44d2ec74d";

function postUrlEncoded(targetUrl, bodyStr) {
  return new Promise((resolve, reject) => {
    const u = new URL(targetUrl);
    const options = {
      method: "POST",
      hostname: u.hostname,
      path: u.pathname + u.search,
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "Content-Length": Buffer.byteLength(bodyStr)
      }
    };

    const req = https.request(options, (res) => {
      let data = "";
      res.setEncoding("utf8");
      res.on("data", (chunk) => (data += chunk));
      res.on("end", () => resolve({ status: res.statusCode, body: data }));
    });

    req.on("error", reject);
    req.write(bodyStr);
    req.end();
  });
}

exports.handler = async (event) => {
  if (event.httpMethod !== "POST") {
    return { statusCode: 405, body: JSON.stringify({ error: "POST only" }) };
  }

  try {
    // Parse the incoming form body
    const params = new URLSearchParams(event.body || "");

    // Grab existing description (if any)
    const currentDesc = params.get("lead[event_description]") || "";

    // Collect address bits
    const addr1 = (params.get("lead[address1]") || "").trim();
    const city  = (params.get("lead[city]") || "").trim();
    const state = (params.get("lead[state]") || "").trim();
    const zip   = (params.get("lead[zip_code]") || "").trim();

    // If user typed any address, append a nicely formatted block into description
    if (addr1 || city || state || zip) {
      const addressBlock = [
        "----- Address -----",
        addr1 ? `Street: ${addr1}` : null,
        city || state || zip ? `City/State/ZIP: ${[city, state, zip].filter(Boolean).join(" ")}` : null,
        "-------------------"
      ].filter(Boolean).join("\n");

      const combined = currentDesc
        ? `${currentDesc}\n\n${addressBlock}`
        : addressBlock;

      params.set("lead[event_description]", combined);
    }

    // Forward to TripleSeat
    const ts = await postUrlEncoded(TS_URL, params.toString());

    // TripleSeat responds with JSON
    return {
      statusCode: ts.status,
      headers: { "Content-Type": "application/json" },
      body: ts.body
    };

  } catch (err) {
    return {
      statusCode: 500,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ok: false, errors: { base: [String(err)] } })
    };
  }
};
</head>
<body>
  <header>
    <img src="Cube_Logo_Final_Small.png" alt="The Cube Central Park logo">
    <h1>Event Request Form</h1>
  </header>
  <img class="logo" src="Cube_Logo_Final_Small.png" alt="The Cube">
<h2>Event Request Form</h2>
<!-- Empty form shell that actually submits -->
<form id="leadForm" method="POST" action="https://mca-tripleseat-form.netlify.app/.netlify/functions/ts-proxy"></form>

<!-- Fields can be anywhere on the page -->
<label>First Name</label>
<input form="leadForm" name="lead[first_name]" required>

<label>Last Name</label>
<input form="leadForm" name="lead[last_name]" required>

<label>Email</label>
<input form="leadForm" type="email" name="lead[email_address]" required>

<label>Phone Number</label>
<input form="leadForm" name="lead[phone_number]" required>

<label>Company</label>
<input form="leadForm" name="lead[company]" required>

<label>Event Date (MM/DD/YY)</label>
<input form="leadForm" name="lead[event_date]" placeholder="MM/DD/YY" required>

<label>Guest Count (min 50)</label>
<input form="leadForm" type="number" name="lead[guest_count]" min="50" required>

<label>Event Type</label>
<input form="leadForm" name="lead[event_type]">

<label>Event Description</label>
<textarea form="leadForm" name="lead[event_description]" required></textarea>

<label>Street Address</label>
<input form="leadForm" name="lead[address1]">

<label>City</label>
<input form="leadForm" name="lead[city]">

<label>State</label>
<input form="leadForm" name="lead[state]" maxlength="2">

<label>ZIP Code</label>
<input form="leadForm" name="lead[zip_code]">

<!-- The submit button must also target the same form -->
<button form="leadForm" type="submit">Submit</button>

  <iframe name="ts_sink" style="display:none"></iframe>

  <script>
  (function(){
    var form = document.getElementById('leadForm');
    if (!form) return;

    form.addEventListener('submit', function(){
      form.innerHTML = '<p>Sending your request...</p>';
    });

    var sink = document.getElementsByName('ts_sink')[0];
    if (sink) {
      sink.addEventListener('load', function(){
        var msg = document.createElement('div');
        msg.innerHTML = '<img src="Cube_Logo_Final_Small.png" alt="The Cube Central Park" style="height:80px; display:block; margin:0 auto 1rem;">' +
                        '<h2 style="text-align:center; color:#004b7c;">Thanks for reaching out!</h2>' +
                        '<p style="text-align:center;">Your request was submitted successfully. Weâ€™ll be in touch within 48 hours.</p>' +
                        '<div style="text-align:center; margin-top:1rem;"><a href="/" style="background:#0077cc; color:#fff; padding:8px 14px; border-radius:5px; text-decoration:none;">Return to Home</a></div>';
        var f = document.getElementById('leadForm');
        if (f) { f.replaceWith(msg); }
      });
    }
  })();
  </script>
</body>
</html>
